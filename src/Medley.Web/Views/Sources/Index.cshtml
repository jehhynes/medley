@model Guid?

@{
    ViewData["Title"] = "Sources";
    ViewData["HasRightSidebar"] = false;
    ViewData["HasLeftSidebar"] = true;
    
    // Only open sidebar on mobile if no specific record is selected
    var openSidebarOnMobile = Model == null;
    ViewData["OpenSidebarOnMobile"] = openSidebarOnMobile;

    Layout = "_VueLayout";
}

@section Styles {
    <style>
        json-viewer {
            --background-color: transparent;
        }
  
               
        
        /* Make main content use flexbox for independent tab scrolling */
        .main-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            padding: 0;
        }
        
        .main-content-header {
            flex-shrink: 0;
            padding: 2rem 2.5rem 0 2.5rem;
            margin-bottom: 0!important;
        }
        
        /* Tab navigation container */
        .main-content .nav-tabs {
            flex-shrink: 0;
            margin: 0 2.5rem;
            padding-top: 1rem;
            border-bottom: 1px solid var(--bs-border-color);
        }
        
        /* Tab content container - takes remaining space and scrolls */
        .main-content .tab-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0; /* Important for flex children to respect overflow */
        }
        
        /* Each tab pane should fill available space and scroll independently */
        .main-content .tab-pane {
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1.5rem 2.5rem 2rem 2.5rem;
            min-height: 0; /* Important for flex children to respect overflow */
        }
        
        /* Content preview - let it flow naturally within scrolling tab pane */
        .content-preview {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Empty state should be centered */
        .main-content .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 2rem 2.5rem;
        }
        
        /* Fragment list styles */
        .fragment-list {
            width: 100%;
        }
        
        .fragment-list .fragment-item:hover {
            background-color: var(--bs-secondary-bg);
        }
        
        /* Fragment modal styles */
        #fragmentModal {
            z-index: 1055;
        }
        
        .modal-backdrop {
            z-index: 1050;
        }
        
        #fragmentModal .markdown-container {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        /* Tag filtering styles */
        .badge[style*="cursor: pointer"]:hover {
            text-decoration: underline;
        }
    </style>
}

<!-- Left Sidebar (List) -->
<div class="sidebar left-sidebar @(openSidebarOnMobile ? "show" : "")">
    <div class="sidebar-header">
        <h6 class="sidebar-title">Sources</h6>
        <div v-if="activeTagFilter" class="mb-2">
            <div class="d-flex align-items-center justify-content-between">
                <span class="badge bg-info rounded-pill">
                    <i class="bi bi-tag-fill me-1"></i>{{ activeTagFilter.value }}
                </span>
                <button class="btn btn-sm btn-link text-muted p-0 ms-2" @@click="clearTagFilter" title="Clear filter">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
        <div class="input-group input-group-sm">
            <input type="text" class="form-control" placeholder="Search..." v-model="searchQuery" @@input="onSearchInput">
        </div>
    </div>
    <div class="sidebar-content">
        <div v-if="loading" class="loading-spinner">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div v-else-if="error" class="alert alert-danger" v-cloak>
            {{ error }}
        </div>
        <source-list 
            v-else
            :sources="sources"
            :selected-id="selectedSourceId"
            @@select="selectSource"
        />
        <div v-if="!loading && sources.length === 0" class="empty-state">
            <div class="empty-state-icon">
                <i class="bi bi-camera-video"></i>
            </div>
            <div class="empty-state-title" v-if="activeTagFilter">No Sources with This Tag</div>
            <div class="empty-state-title" v-else>No Sources Found</div>
            <div class="empty-state-text" v-if="activeTagFilter">Try selecting a different tag or clear the filter</div>
            <div class="empty-state-text" v-else>Connect an integration to import sources</div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="main-content">
    <div v-if="!selectedSource" class="empty-state">
        <div class="empty-state-icon">
            <i class="bi bi-camera-video"></i>
        </div>
        <div class="empty-state-title">No Source Selected</div>
        <div class="empty-state-text">Select a source from the sidebar to view its details</div>
    </div>
    <div v-else class="d-flex flex-column h-100">
        <div class="main-content-header">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h1 class="main-content-title">{{ selectedSource.name || 'Untitled Source' }}</h1>
                    <div class="text-muted">
                        <span class="badge bg-primary">
                            <i :class="getIconClass(getSourceTypeIcon(selectedSource.type))" class="me-1"></i>{{ selectedSource.type }}
                        </span>
                        <span class="ms-2">
                            <i class="bi bi-calendar3"></i>
                            {{ formatDate(selectedSource.date) }}
                        </span>
                        <span class="ms-2">
                            <i class="bi bi-plug"></i>
                            {{ selectedSource.integrationName }}
                        </span>
                        <span class="ms-2" v-if="selectedSource.fragmentsCount !== undefined">
                            <i class="bi bi-puzzle"></i>
                            {{ selectedSource.fragmentsCount }} fragments
                        </span>
                    </div>
                    <div class="mt-2" v-if="sortedTags.length || selectedSource.isInternal">
                        <span
                            v-if="selectedSource.isInternal"
                            class="badge rounded-pill bg-success me-1 mb-1">
                            Internal
                        </span>
                        <span 
                            v-for="tag in sortedTags" 
                            :key="tag.tagTypeId"
                            class="badge rounded-pill bg-info me-1 mb-1"
                            @@click.stop="filterByTag(tag)"
                            style="cursor: pointer;"
                            :title="activeTagFilter && activeTagFilter.tagTypeId === tag.tagTypeId && activeTagFilter.value === tag.value ? 'Click to clear filter' : 'Click to filter by this tag'">
                            {{ tag.value }}
                        </span>
                    </div>
                </div>
                <div>
                    <button 
                        class="btn btn-primary" 
                        @@click="extractFragments" 
                        :disabled="selectedSource.extractionStatus === 'InProgress'"
                        v-if="selectedSource.content">
                        <span v-if="selectedSource.extractionStatus === 'InProgress'" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <i v-else class="bi bi-magic"></i> 
                        {{ selectedSource.extractionStatus === 'Completed' ? 'Re-extract Fragments' : 'Extract Fragments' }}
                    </button>
                    <button 
                        class="btn btn-outline-secondary ms-2" 
                        @@click="generateTags" 
                        :disabled="tagging || !selectedSource"
                        v-if="!selectedSource.tagsGenerated">
                        <span v-if="tagging" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <i v-else class="bi bi-tags"></i> Generate Tags
                    </button>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="content-tab" data-bs-toggle="tab" data-bs-target="#content-pane" type="button" role="tab" aria-controls="content-pane" aria-selected="true">
                    Content
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="fragments-tab" data-bs-toggle="tab" data-bs-target="#fragments-pane" type="button" role="tab" aria-controls="fragments-pane" aria-selected="false">
                    Fragments
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="metadata-tab" data-bs-toggle="tab" data-bs-target="#metadata-pane" type="button" role="tab" aria-controls="metadata-pane" aria-selected="false">
                    Metadata
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane show active" id="content-pane" role="tabpanel" aria-labelledby="content-tab">
                <div v-if="selectedSource.content">
                    <div class="content-preview">
                        {{ selectedSource.content }}
                    </div>
                </div>
                <div v-else class="text-muted">
                    No content available
                </div>
            </div>
            <div class="tab-pane" id="fragments-pane" role="tabpanel" aria-labelledby="fragments-tab">
                <div v-if="loadingFragments" class="text-center py-4">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div v-else-if="fragmentsError" class="alert alert-danger" v-cloak>
                    {{ fragmentsError }}
                </div>
                <template v-else>
                    <div v-if="selectedSource && selectedSource.extractionMessage && fragments.length === 0" class="alert alert-info mb-3" v-cloak>
                        <div class="d-flex align-items-start">
                            <i class="bi bi-info-circle me-2 mt-1"></i>
                            <div class="flex-grow-1">
                                <strong>Extraction Message:</strong>
                                <div class="mt-1">{{ selectedSource.extractionMessage }}</div>
                            </div>
                        </div>
                    </div>
                    <div v-if="fragments.length === 0 && (!selectedSource || !selectedSource.extractionMessage)" class="text-muted">
                        No fragments available. Click "Extract Fragments" to generate fragments from this source.
                    </div>
                    <div v-else class="fragment-list">
                        <table class="table table-hover">
                            <tbody>
                                <tr 
                                    v-for="fragment in fragments" 
                                    :key="fragment.id"
                                    class="fragment-item"
                                    @@click="selectFragment(fragment)"
                                    style="cursor: pointer;"
                                >
                                    <td class="align-middle" style="width: 50px;">
                                        <i 
                                            :class="getIconClass(getFragmentCategoryIcon(fragment.category))" 
                                            :title="fragment.category || ''"
                                            style="font-size: 1.25rem;"
                                        ></i>
                                    </td>
                                    <td>
                                        <div class="fw-semibold">{{ fragment.title || 'Untitled Fragment' }}</div>
                                        <div v-if="fragment.summary" class="text-muted small">
                                            {{ fragment.summary }}
                                        </div>
                                    </td>
                                    <td class="align-middle text-end" style="width: 100px;" v-if="fragment.confidence !== null && fragment.confidence !== undefined">
                                        <i 
                                            :class="'fa-duotone ' + getConfidenceIcon(fragment.confidence)" 
                                            :style="{ color: getConfidenceColor(fragment.confidence) }"
                                            :title="'Confidence: ' + getConfidenceLabel(fragment.confidence)"
                                            style="font-size: 1.25rem;"
                                        ></i>
                                        @* <small class="text-muted ms-1">{{ getConfidenceLabel(fragment.confidence) }}</small> *@
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </template>
            </div>
            <div class="tab-pane" id="metadata-pane" role="tabpanel" aria-labelledby="metadata-tab">
                <div v-if="parsedMetadata">
                    <json-viewer ref="jsonViewer"></json-viewer>
                </div>
                <div v-else class="text-muted">
                    No metadata available
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fragment Detail Modal -->
<div v-if="selectedFragment" class="modal fade show" id="fragmentModal" tabindex="-1" aria-labelledby="fragmentModalLabel" style="display: block;" @@click.self="closeFragmentModal">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fragmentModalLabel">
                    {{ selectedFragment.title || 'Untitled Fragment' }}
                </h5>
                <button type="button" class="btn-close" @@click="closeFragmentModal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <span v-if="selectedFragment.category" class="badge bg-secondary me-2">
                        <i :class="getIconClass(getFragmentCategoryIcon(selectedFragment.category))" class="me-1"></i>{{ selectedFragment.category }}
                    </span>
                    <span 
                        v-if="selectedFragment.confidence !== null && selectedFragment.confidence !== undefined && selectedFragment.confidenceComment" 
                        class="badge bg-light text-dark"
                        @@click="toggleConfidenceComment"
                        style="cursor: pointer;"
                        :title="showConfidenceComment ? 'Hide confidence note' : 'Show confidence note'">
                        <i 
                            :class="'fa-duotone ' + getConfidenceIcon(selectedFragment.confidence)" 
                            :style="{ color: getConfidenceColor(selectedFragment.confidence) }"
                            class="me-1"
                        ></i>
                        Confidence: {{ getConfidenceLabel(selectedFragment.confidence) }}
                        <i :class="showConfidenceComment ? 'bi bi-chevron-up ms-1' : 'bi bi-chevron-down ms-1'"></i>
                    </span>
                    <span 
                        v-else-if="selectedFragment.confidence !== null && selectedFragment.confidence !== undefined" 
                        class="badge bg-light text-dark">
                        <i 
                            :class="'fa-duotone ' + getConfidenceIcon(selectedFragment.confidence)" 
                            :style="{ color: getConfidenceColor(selectedFragment.confidence) }"
                            class="me-1"
                        ></i>
                        Confidence: {{ getConfidenceLabel(selectedFragment.confidence) }}
                    </span>
                </div>
                <div v-if="selectedFragment.confidenceComment && showConfidenceComment" class="alert alert-info mb-3">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-info-circle me-2 mt-1"></i>
                        <div>
                            <strong>Confidence Note:</strong>
                            <div class="mt-1">{{ selectedFragment.confidenceComment }}</div>
                        </div>
                    </div>
                </div>
                <div class="markdown-container" v-html="renderedMarkdown"></div>
            </div>
        </div>
    </div>
</div>
<div v-if="selectedFragment" class="modal-backdrop fade show"></div>

@section Scripts {
    <script src="~/lib/marked/marked.min.js" asp-append-version="true"></script>
    <script src="~/lib/bootbox/dist/bootbox.all.min.js" asp-append-version="true"></script>
    <script src="~/js/app.js" asp-append-version="true"></script>
    <script src="~/js/utils.js" asp-append-version="true"></script>
    <script src="~/js/url-utils.js" asp-append-version="true"></script>
    <script src="~/js/components/source-list.js" asp-append-version="true"></script>
    <script src="~/js/pages/sources.js" asp-append-version="true"></script>
}
