@{
    ViewData["Title"] = "Articles";
    ViewData["HasRightSidebar"] = true;
    ViewData["HasLeftSidebar"] = true;
    Layout = "_VueLayout";
}

<!-- Left Sidebar (List/Tree) -->
<div class="sidebar left-sidebar">
    <div class="sidebar-header">
        <div class="d-flex align-items-center gap-2">
            <h6 class="sidebar-title mb-0 flex-grow-1">Articles</h6>
            <div class="position-relative">
                <button class="btn btn-sm btn-outline-secondary" @@click.stop="toggleSidebarMenu" title="Actions">
                    <i class="bi bi-three-dots"></i>
                </button>
                <div v-if="ui.sidebarMenuOpen" v-cloak class="dropdown-menu show position-absolute" style="right: 0; top: 100%; margin-top: 0.25rem;" @@click.stop>
                    <button class="dropdown-item" @@click="showCreateArticleModal(null)">New Article</button>
                </div>
            </div>
        </div>
    </div>
    <div class="sidebar-content">
        <div v-if="ui.loading" class="loading-spinner">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div v-else-if="ui.error" class="alert alert-danger" v-cloak>
            {{ ui.error }}
        </div>
        <article-tree 
            v-else
            :articles="articles.list"
            :selected-id="articles.selectedId"
            :expanded-ids="articles.expandedIds"
            :article-type-icon-map="articles.typeIconMap"
            :article-types="articles.types"
            @@select="selectArticle"
            @@toggle-expand="toggleExpand"
            @@create-child="showCreateArticleModal"
            @@edit-article="showEditArticleModal"
            @@move-article="moveArticle"
        />
    </div>
</div>

<!-- Main Content -->
<div class="main-content" :class="{ 'd-flex flex-column': articles.selected }" :style="articles.selected ? 'padding: 0;' : ''">
    <div v-if="!articles.selected" class="empty-state">
        <div class="empty-state-icon">
            <i class="bi bi-file-text"></i>
        </div>
        <div class="empty-state-title">No Article Selected</div>
        <div class="empty-state-text">Select an article from the sidebar to view its details</div>
    </div>
    <div v-else-if="selectedVersion" v-cloak class="diff-viewer d-flex flex-column flex-grow-1">
        <div class="diff-viewer-header">
            <button class="btn btn-sm btn-outline-secondary" @@click="clearVersionSelection">
                <i class="bi bi-arrow-left"></i> Back to Editor
            </button>
            <div class="diff-viewer-title">
                <span class="badge bg-primary me-2">Version {{ selectedVersion.versionNumber }}</span>
                <span class="text-muted">{{ formatDate(selectedVersion.createdAt) }}</span>
                <span v-if="selectedVersion.createdByName" class="text-muted ms-2">
                    by {{ selectedVersion.createdByName }}
                </span>
            </div>
        </div>
        <div class="diff-viewer-content flex-grow-1">
            <div v-if="loadingDiff" class="loading-spinner">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading diff...</span>
                </div>
            </div>
            <div v-else-if="diffError" class="alert alert-danger m-3">
                {{ diffError }}
            </div>
            <div v-else-if="diffHtml" v-html="diffHtml" class="diff-content"></div>
        </div>
    </div>
    <tiptap-editor v-else
                   ref="tiptapEditor"
                   v-model="editor.content"
                   :key="articles.selectedId"
                   :is-saving="editor.isSaving"
                   @@save="saveArticle"
                   class="flex-grow-1"
                   placeholder="Start writing your article content..." />
</div>

<!-- Right Sidebar -->
<div class="sidebar right-sidebar">
    <div class="sidebar-header">
        <div class="sidebar-tabs">
            <button 
                class="sidebar-tab" 
                :class="{ 'active': ui.activeRightTab === 'chat' }"
                @@click="setActiveRightTab('chat')">
                <i class="bi bi-chat-dots"></i> Chat
            </button>
            <button 
                class="sidebar-tab" 
                :class="{ 'active': ui.activeRightTab === 'versions' }"
                @@click="setActiveRightTab('versions')">
                <i class="bi bi-clock-history"></i> Versions
            </button>
        </div>
    </div>
    <div class="sidebar-tab-content">
        <div v-show="ui.activeRightTab === 'chat'" class="sidebar-tab-pane">
            <chat-panel :article-id="articles.selectedId" />
        </div>
        <div v-show="ui.activeRightTab === 'versions'" class="sidebar-tab-pane">
            <versions-panel 
                ref="versionsPanel"
                :article-id="articles.selectedId"
                :selected-version-id="selectedVersion?.id"
                @@select-version="handleVersionSelect" />
        </div>
    </div>
</div>

<!-- Create Article Modal -->
<div v-if="createModal.visible" v-cloak class="modal d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);" @@click.self="closeCreateModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Article</h5>
                <button type="button" class="btn-close" @@click="closeCreateModal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <p class="text-muted small mb-3" v-if="createModal.parentId === null">
                        Creating at root level
                    </p>
                    <p class="text-muted small mb-3" v-else>
                        Creating as child article
                    </p>
                </div>
                
                <div class="mb-3 form-group-overlap">
                    <input 
                        type="text" 
                        class="form-control" 
                        v-model="createModal.title"
                        @@keyup.enter="createArticle"
                        @@keyup.esc="closeCreateModal"
                        ref="titleInput" />
                    <label>Title *</label>
                </div>

                <div class="mb-3 form-group-overlap">
                    <select class="form-select" v-model="createModal.typeId">
                        <option :value="null" disabled>Select article type</option>
                        <option v-for="type in articles.types" :key="type.id" :value="type.id">
                            {{ type.name }}
                        </option>
                    </select>
                    <label>Article Type *</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" @@click="closeCreateModal">Cancel</button>
                <button type="button" class="btn btn-primary" @@click="createArticle" :disabled="createModal.isSubmitting">
                    <i class="bi bi-save"></i> Save Article
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Article Modal -->
<div v-if="editModal.visible" v-cloak class="modal d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);" @@click.self="closeEditModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Article</h5>
                <button type="button" class="btn-close" @@click="closeEditModal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 form-group-overlap">
                    <input 
                        type="text" 
                        class="form-control" 
                        v-model="editModal.title"
                        @@keyup.enter="updateArticle"
                        @@keyup.esc="closeEditModal"
                        ref="editTitleInput" />
                    <label>Title *</label>
                </div>

                <div class="mb-3 form-group-overlap">
                    <select class="form-select" v-model="editModal.typeId">
                        <option :value="null" disabled>Select article type</option>
                        <option v-for="type in articles.types" :key="type.id" :value="type.id">
                            {{ type.name }}
                        </option>
                    </select>
                    <label>Article Type *</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" @@click="closeEditModal">Cancel</button>
                <button type="button" class="btn btn-primary" @@click="updateArticle" :disabled="editModal.isSubmitting">
                    <i class="bi bi-save"></i> Save Article
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/bootbox/dist/bootbox.all.min.js" asp-append-version="true"></script>
    <script src="~/lib/marked/marked.min.js" asp-append-version="true"></script>
    <script src="~/js/htmlDiff.js" asp-append-version="true"></script>
    <script src="~/js/app.js" asp-append-version="true"></script>
    <script src="~/js/utils.js" asp-append-version="true"></script>
    <script src="~/js/url-utils.js" asp-append-version="true"></script>
    <script src="~/js/components/article-tree.js" asp-append-version="true"></script>
    <script src="~/js/components/chat-panel.js" asp-append-version="true"></script>
    <script src="~/js/components/versions-panel.js" asp-append-version="true"></script>
    <script type="module" src="~/js/components/tiptap-editor.js" asp-append-version="true"></script>
    <script src="~/js/pages/articles.js" asp-append-version="true"></script>
}
