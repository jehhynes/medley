@model Guid?

@{
    ViewData["Title"] = "Articles";
    ViewData["HasRightSidebar"] = true;
    ViewData["HasLeftSidebar"] = true;

    // Only open sidebar on mobile if no specific record is selected
    var openSidebarOnMobile = Model == null;
    ViewData["OpenSidebarOnMobile"] = openSidebarOnMobile;

    Layout = "_VueLayout";
}

<!-- Left Sidebar (List/Tree) -->
<div class="sidebar left-sidebar @(openSidebarOnMobile ? "show" : "")">
    <div class="sidebar-header">
        <div class="d-flex align-items-center gap-2">
            <h6 class="sidebar-title mb-0 flex-grow-1">Articles</h6>
            <div class="btn-group" role="group" v-cloak>
                <button type="button" class="btn btn-sm btn-outline-secondary" :class="{ active: viewMode === 'tree' }" @@click="setViewMode('tree')" title="Tree View">
                    <i class="bi bi-diagram-3"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" :class="{ active: viewMode === 'list' }" @@click="setViewMode('list')" title="List View">
                    <i class="bi bi-list-ul"></i>
                </button>
            </div>
            <button class="btn btn-sm btn-outline-secondary position-relative" @@click="showFilterModal" title="Filter Articles" v-cloak>
                <i class="bi bi-funnel"></i>
                <span v-if="hasActiveFilters" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-primary">
                    {{ activeFilterCount }}
                </span>
            </button>
            <div class="position-relative">
                <button class="btn btn-sm btn-outline-secondary" @@click.stop="toggleSidebarMenu" title="Actions">
                    <i class="bi bi-three-dots"></i>
                </button>
                <div v-if="ui.sidebarMenuOpen" v-cloak class="dropdown-menu show position-absolute" style="right: 0; top: 100%; margin-top: 0.25rem;" @@click.stop>
                    <button v-if="viewMode === 'tree'" class="dropdown-item" @@click="showCreateArticleModal(null)">New Article</button>
                    <span v-else class="dropdown-item-text text-muted fst-italic text-nowrap">No actions available</span>
                </div>
            </div>
        </div>
    </div>
    <div class="sidebar-content">
        <div v-if="ui.loading" class="loading-spinner">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div v-else-if="ui.error" class="alert alert-danger" v-cloak>
            {{ ui.error }}
        </div>
        <template v-else>
            <article-tree 
                v-show="viewMode === 'tree'"
                v-cloak
                :articles="articles.list"
                :selected-id="articles.selectedId"
                :expanded-ids="articles.expandedIds"
                :article-type-icon-map="articles.typeIconMap"
                :article-types="articles.types"
                @@select="selectArticle"
                @@toggle-expand="toggleExpand"
                @@create-child="showCreateArticleModal"
                @@edit-article="showEditArticleModal"
                @@move-article="moveArticle"
            ></article-tree>
            <article-list
                v-show="viewMode === 'list'"
                v-cloak
                :articles="flatArticlesList"
                :selected-id="articles.selectedId"
                :article-type-icon-map="articles.typeIconMap"
                :article-types="articles.types"
                :breadcrumbs-cache="articles.breadcrumbsCache"
                @@select="selectArticle"
                @@create-child="showCreateArticleModal"
                @@edit-article="showEditArticleModal"
            ></article-list>
        </template>
    </div>
</div>

<!-- Main Content -->
<div class="main-content d-flex flex-column" :style="articles.selected ? 'padding: 0;' : ''">
    <div v-if="!articles.selected" class="empty-state" v-cloak>
        <div class="empty-state-icon">
            <i class="bi bi-file-text"></i>
        </div>
        <div class="empty-state-title">No Article Selected</div>
        <div class="empty-state-text">Select an article from the sidebar to view its details</div>
    </div>
    <div v-else-if="version.selected" v-cloak class="diff-viewer d-flex flex-column flex-grow-1">
        <div class="diff-viewer-header">
            <button class="btn btn-sm btn-outline-secondary" @@click="clearVersionSelection">
                <i class="bi bi-arrow-left"></i> Back to Editor
            </button>
            <div class="diff-viewer-title">
                <span class="badge bg-primary me-2">Version {{ version.selected.versionNumber }}</span>
                <span class="text-muted">{{ formatDate(version.selected.createdAt) }}</span>
                <span v-if="version.selected.createdByName" class="text-muted ms-2">
                    by {{ version.selected.createdByName }}
                </span>
            </div>
        </div>
        <div class="diff-viewer-content flex-grow-1">
            <div v-if="version.loadingDiff" class="loading-spinner">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading diff...</span>
                </div>
            </div>
            <div v-else-if="version.diffError" class="alert alert-danger m-3">
                {{ version.diffError }}
            </div>
            <div v-else-if="version.diffHtml" v-html="version.diffHtml" class="diff-content"></div>
        </div>
    </div>
    <tiptap-editor v-else
                   ref="tiptapEditor"
                   v-model="editor.content"
                   :key="articles.selectedId"
                   :is-saving="editor.isSaving"
                   @@save="saveArticle"
                   class="flex-grow-1"
                   placeholder="Start writing your article content..." />
</div>

<!-- Right Sidebar -->
<div class="sidebar right-sidebar">
    <div class="sidebar-header">
        <div class="sidebar-tabs">
            <button 
                class="sidebar-tab" 
                :class="{ 'active': ui.activeRightTab === 'assistant' }"
                @@click="setActiveRightTab('assistant')">
                <i class="bi bi-chat-dots"></i> Assistant
            </button>
            <button 
                class="sidebar-tab" 
                :class="{ 'active': ui.activeRightTab === 'versions' }"
                @@click="setActiveRightTab('versions')">
                <i class="bi bi-clock-history"></i> Versions
            </button>
        </div>
    </div>
    <div class="sidebar-tab-content">
        <div v-show="ui.activeRightTab === 'assistant'" class="sidebar-tab-pane">
            <chat-panel :article-id="articles.selectedId" />
        </div>
        <div v-show="ui.activeRightTab === 'versions'" class="sidebar-tab-pane">
            <versions-panel 
                ref="versionsPanel"
                :article-id="articles.selectedId"
                :selected-version-id="version.selected?.id"
                @@select-version="handleVersionSelect" />
        </div>
    </div>
</div>

<!-- Create Article Modal -->
<div v-if="createModal.visible" v-cloak class="modal d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);" @@click.self="closeCreateModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Article</h5>
                <button type="button" class="btn-close" @@click="closeCreateModal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <p class="text-muted small mb-3" v-if="createModal.parentId === null">
                        Creating at root level
                    </p>
                    <p class="text-muted small mb-3" v-else>
                        Creating as child article
                    </p>
                </div>
                
                <div class="mb-3 form-group-overlap">
                    <input 
                        type="text" 
                        class="form-control" 
                        v-model="createModal.title"
                        @@keyup.enter="createArticle"
                        @@keyup.esc="closeCreateModal"
                        ref="titleInput" />
                    <label>Title *</label>
                </div>

                <div class="mb-3 form-group-overlap">
                    <select class="form-select" v-model="createModal.typeId">
                        <option :value="null" disabled>Select article type</option>
                        <option v-for="type in articles.types" :key="type.id" :value="type.id">
                            {{ type.name }}
                        </option>
                    </select>
                    <label>Article Type *</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" @@click="closeCreateModal">Cancel</button>
                <button type="button" class="btn btn-primary" @@click="createArticle" :disabled="createModal.isSubmitting">
                    <i class="bi bi-save"></i> Save Article
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Article Modal -->
<div v-if="editModal.visible" v-cloak class="modal d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);" @@click.self="closeEditModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Article</h5>
                <button type="button" class="btn-close" @@click="closeEditModal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 form-group-overlap">
                    <input 
                        type="text" 
                        class="form-control" 
                        v-model="editModal.title"
                        @@keyup.enter="updateArticle"
                        @@keyup.esc="closeEditModal"
                        ref="editTitleInput" />
                    <label>Title *</label>
                </div>

                <div class="mb-3 form-group-overlap">
                    <select class="form-select" v-model="editModal.typeId">
                        <option :value="null" disabled>Select article type</option>
                        <option v-for="type in articles.types" :key="type.id" :value="type.id">
                            {{ type.name }}
                        </option>
                    </select>
                    <label>Article Type *</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" @@click="closeEditModal">Cancel</button>
                <button type="button" class="btn btn-primary" @@click="updateArticle" :disabled="editModal.isSubmitting">
                    <i class="bi bi-save"></i> Save Article
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div v-if="filterModal.visible" v-cloak class="modal d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);" @@click.self="closeFilterModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Filter Articles</h5>
                <button type="button" class="btn-close" @@click="closeFilterModal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Text Search -->
                <div class="mb-3 form-group-overlap">
                    <input 
                        type="text" 
                        class="form-control" 
                        v-model="filters.query"
                        @@keyup.enter="applyFilters"
                        @@keyup.esc="closeFilterModal"
                        ref="filterSearchInput"
                        placeholder=" " />
                    <label>Search by title</label>
                </div>

                <!-- Status Filter -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Status</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" :checked="isStatusSelected(0)" @@change="toggleStatusFilter(0)" id="status-draft">
                                <label class="form-check-label" for="status-draft">
                                    <i class="bi bi-pencil me-1 text-secondary"></i>Draft
                                </label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" :checked="isStatusSelected(1)" @@change="toggleStatusFilter(1)" id="status-review">
                                <label class="form-check-label" for="status-review">
                                    <i class="bi bi-eye me-1 text-info"></i>Review
                                </label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" :checked="isStatusSelected(2)" @@change="toggleStatusFilter(2)" id="status-approved">
                                <label class="form-check-label" for="status-approved">
                                    <i class="bi bi-check-circle me-1 text-success"></i>Approved
                                </label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" :checked="isStatusSelected(3)" @@change="toggleStatusFilter(3)" id="status-archived">
                                <label class="form-check-label" for="status-archived">
                                    <i class="bi bi-archive me-1 text-danger"></i>Archived
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Article Type Filter -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Article Type</label>
                    <div class="row g-2">
                        <div v-for="type in articles.types" :key="type.id" class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" :checked="isArticleTypeSelected(type.id)" @@change="toggleArticleTypeFilter(type.id)" :id="'type-' + type.id">
                                <label class="form-check-label" :for="'type-' + type.id">
                                    <i :class="getArticleTypeIconClass(type.icon)" class="me-1"></i>{{ type.name }}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" @@click="clearFilters">
                    <i class="bi bi-x-circle"></i> Clear Filters
                </button>
                <button type="button" class="btn btn-primary" @@click="applyFilters">
                    <i class="bi bi-check-circle"></i> Apply Filters
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/bootbox/dist/bootbox.all.min.js" asp-append-version="true"></script>
    <script src="~/lib/marked/marked.min.js" asp-append-version="true"></script>
    <script src="~/js/htmlDiff.js" asp-append-version="true"></script>
    <script src="~/js/app.js" asp-append-version="true"></script>
    <script src="~/js/utils.js" asp-append-version="true"></script>
    <script src="~/js/url-utils.js" asp-append-version="true"></script>
    <script src="~/js/mixins/dropdownMixin.js" asp-append-version="true"></script>
    <script src="~/js/mixins/articleModalMixin.js" asp-append-version="true"></script>
    <script src="~/js/mixins/articleFilterMixin.js" asp-append-version="true"></script>
    <script src="~/js/components/article-tree.js" asp-append-version="true"></script>
    <script src="~/js/components/virtual-scroller.js" asp-append-version="true"></script>
    <script src="~/js/components/article-list.js" asp-append-version="true"></script>
    <script src="~/js/components/chat-panel.js" asp-append-version="true"></script>
    <script src="~/js/components/versions-panel.js" asp-append-version="true"></script>
    <script type="module" src="~/js/components/tiptap-editor.js" asp-append-version="true"></script>
    <script src="~/js/mixins/articleVersionMixin.js" asp-append-version="true"></script>
    <script src="~/js/mixins/articleSignalRMixin.js" asp-append-version="true"></script>
    <script src="~/js/pages/articles.js" asp-append-version="true"></script>
}
