@{
    ViewData["Title"] = "AI Prompts";
    ViewData["HasLeftSidebar"] = true;
    Layout = "_VueLayout";
}

<!-- Left Sidebar (Template List) -->
<div class="sidebar left-sidebar">
    <div class="sidebar-header">
        <h6 class="sidebar-title sidebar-breadcrumb-title">
            <a asp-area="Admin" asp-controller="Settings" asp-action="Index">Settings</a>
            <i class="bi bi-chevron-right"></i>
            <span>AI Prompts</span>
        </h6>
    </div>
    <div class="sidebar-content">
        <div v-if="loading" class="loading-spinner">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div v-else-if="error" class="alert alert-danger" v-cloak>
            {{ error }}
        </div>
        <ul v-else class="list-view" v-cloak>
            <li v-for="template in templates" :key="template.id" class="list-item">
                <a href="#" 
                   class="list-item-content"
                   :class="{ active: selectedTemplateId === template.id }"
                   @@click.prevent="selectTemplate(template)">
                    <i class="list-item-icon bi bi-file-earmark-code"></i>
                    <div class="list-item-body">
                        <div class="list-item-title">{{ template.name }}</div>
                        <div class="list-item-subtitle">{{ template.description || template.typeName }}</div>
                    </div>
                </a>
            </li>
        </ul>
    </div>
</div>

<!-- Main Content -->
<div class="main-content" :class="{ 'd-flex flex-column': selectedTemplate }" :style="selectedTemplate ? 'padding: 0;' : ''">
    <div v-if="!selectedTemplate" class="empty-state" v-cloak>
        <div class="empty-state-icon">
            <i class="bi bi-file-earmark-code"></i>
        </div>
        <div class="empty-state-title">No Prompt Selected</div>
        <div class="empty-state-text">Select a prompt template from the sidebar to edit it</div>
    </div>

    <template v-else v-cloak>
        <!-- Template Header -->
        <div class="template-editor-header">
            <div class="template-editor-header-content">
                <h5 class="template-name">{{ selectedTemplate.name }}</h5>
            </div>
            <div class="template-editor-actions">
                <button type="button" 
                        class="btn btn-sm btn-primary" 
                        @@click="saveTemplate"
                        :disabled="isSaving || !hasChanges">
                    <span v-if="isSaving" class="spinner-border spinner-border-sm me-1"></span>
                    <i v-else class="bi bi-save me-1"></i>
                    {{ isSaving ? 'Saving...' : 'Save' }}
                </button>
            </div>
        </div>

        <!-- Editor -->
        <tiptap-editor 
            v-model="editingContent"
            :key="selectedTemplateId"
            class="flex-grow-1"
            placeholder="Enter the prompt template content..." />

        <!-- Save indicator -->
        <div v-if="lastSaved" class="template-save-indicator text-muted">
            <i class="bi bi-check-circle me-1"></i>
            Last saved: {{ formatTime(lastSaved) }}
        </div>
    </template>
</div>

@section Styles {
    <style>
        .sidebar-breadcrumb-title {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .sidebar-breadcrumb-title a {
            color: var(--bs-secondary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .sidebar-breadcrumb-title a:hover {
            color: var(--bs-primary);
        }

        .sidebar-breadcrumb-title i {
            font-size: 0.6rem;
            color: var(--bs-secondary-color);
        }

        .sidebar-breadcrumb-title span {
            color: var(--bs-body-color);
        }

        .template-editor-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--bs-border-color);
            background-color: var(--bs-body-bg);
            gap: 1rem;
        }

        .template-editor-header-content {
            flex: 1;
            min-width: 0;
        }

        .template-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--bs-body-color);
            margin: 0 0 0.25rem 0;
        }

        .template-description {
            font-size: 0.875rem;
            color: var(--bs-secondary-color);
            margin: 0;
        }

        .template-editor-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .template-save-indicator {
            padding: 0.5rem 1.5rem;
            font-size: 0.75rem;
            border-top: 1px solid var(--bs-border-color);
            background-color: var(--bs-body-bg);
        }
    </style>
}

@section Scripts {
    <script src="~/js/app.js"></script>
    <script src="~/js/utils.js"></script>
    <script type="module" src="~/js/components/tiptap-editor.js"></script>
    <script>
        (function() {
            const { createApp } = Vue;
            const { api } = window.ArticleBrowserApp;

            // Wait for TiptapEditor to load before mounting the app
            function initializeApp() {
                if (!window.TiptapEditor) {
                    setTimeout(initializeApp, 100);
                    return;
                }

                const app = createApp({
                    components: {
                        'tiptap-editor': window.TiptapEditor
                    },
                    data() {
                        return {
                            templates: [],
                            selectedTemplateId: null,
                            selectedTemplate: null,
                            loading: false,
                            error: null,
                            editingContent: '',
                            originalContent: '',
                            isSaving: false,
                            lastSaved: null
                        };
                    },
                    computed: {
                        hasChanges() {
                            return this.editingContent !== this.originalContent;
                        }
                    },
                    methods: {
                        async loadTemplates() {
                            this.loading = true;
                            this.error = null;
                            try {
                                this.templates = await api.get('/api/templates');
                            } catch (err) {
                                this.error = 'Failed to load templates: ' + err.message;
                                console.error('Error loading templates:', err);
                            } finally {
                                this.loading = false;
                            }
                        },

                        async selectTemplate(template) {
                            try {
                                const fullTemplate = await api.get(`/api/templates/${template.id}`);
                                
                                this.selectedTemplate = fullTemplate;
                                this.selectedTemplateId = template.id;
                                this.editingContent = fullTemplate.content || '';
                                this.originalContent = fullTemplate.content || '';
                                this.lastSaved = fullTemplate.lastModifiedAt ? new Date(fullTemplate.lastModifiedAt) : null;
                                
                                // Update URL
                                const url = new URL(window.location);
                                if (url.searchParams.get('id') !== template.id) {
                                    url.searchParams.set('id', template.id);
                                    window.history.pushState({}, '', url);
                                }
                            } catch (err) {
                                console.error('Error loading template:', err);
                                this.error = 'Failed to load template: ' + err.message;
                            }
                        },

                        async saveTemplate() {
                            if (!this.selectedTemplate || this.isSaving) return;

                            this.isSaving = true;
                            try {
                                const updated = await api.put(`/api/templates/${this.selectedTemplate.id}`, {
                                    content: this.editingContent
                                });

                                this.selectedTemplate = updated;
                                this.originalContent = updated.content;
                                this.lastSaved = new Date();
                            } catch (err) {
                                console.error('Error saving template:', err);
                                alert('Failed to save template: ' + err.message);
                            } finally {
                                this.isSaving = false;
                            }
                        },

                        formatTime(date) {
                            if (!date) return '';
                            return new Date(date).toLocaleTimeString();
                        }
                    },

                    async mounted() {
                        await this.loadTemplates();

                        // Check URL for selected template ID
                        const urlParams = new URLSearchParams(window.location.search);
                        const templateIdFromUrl = urlParams.get('id');
                        if (templateIdFromUrl) {
                            const template = this.templates.find(t => t.id === templateIdFromUrl);
                            if (template) {
                                await this.selectTemplate(template);
                            }
                        } else if (this.templates.length > 0) {
                            // Auto-select first template
                            await this.selectTemplate(this.templates[0]);
                        }

                        // Handle browser back/forward
                        window.addEventListener('popstate', async () => {
                            const urlParams = new URLSearchParams(window.location.search);
                            const templateId = urlParams.get('id');
                            if (templateId && templateId !== this.selectedTemplateId) {
                                const template = this.templates.find(t => t.id === templateId);
                                if (template) {
                                    await this.selectTemplate(template);
                                }
                            }
                        });
                    }
                });

                app.mount('#app');
            }

            // Start initialization
            initializeApp();
        })();
    </script>
}

