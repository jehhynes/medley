@{
    ViewData["Title"] = "Settings";
    var fragmentExtractionPrompt = ViewBag.FragmentExtractionPrompt as string ?? "";
    var templateId = ViewBag.FragmentExtractionTemplateId as Guid? ?? Guid.Empty;
    var organizationId = ViewBag.OrganizationId as Guid? ?? Guid.Empty;
    var emailDomain = ViewBag.EmailDomain as string ?? "";
    var enableSmartTagging = ViewBag.EnableSmartTagging as bool? ?? false;
}

<div class="main-content-header">
    <h1 class="main-content-title">Settings</h1>
    <p class="text-muted">Configure system settings and AI prompts</p>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Organization Settings</h5>
    </div>
    <div class="card-body">
        <p class="text-muted mb-3">
            Configure organization-wide settings for smart tagging and email domain detection.
        </p>
        
        <form asp-action="SaveOrganizationSettings" method="post">
            <input type="hidden" name="organizationId" value="@organizationId" />
            
            <div class="mb-3">
                <label for="emailDomain" class="form-label">Email Domain</label>
                <input type="text" 
                       class="form-control" 
                       id="emailDomain" 
                       name="emailDomain" 
                       value="@emailDomain"
                       placeholder="company.com"
                       maxlength="100" />
                <div class="form-text">
                    The email domain used to identify internal attendees (e.g., "company.com"). 
                    Sources where all attendees are from this domain will be automatically tagged as internal.
                </div>
            </div>
            
            <div class="mb-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" 
                           type="checkbox" 
                           id="enableSmartTagging" 
                           name="enableSmartTagging" 
                           value="true"
                           @(enableSmartTagging ? "checked" : "") />
                    <label class="form-check-label" for="enableSmartTagging">
                        Enable Smart Tagging
                    </label>
                </div>
                <div class="form-text">
                    When enabled, the system will automatically tag sources as internal/external based on attendee email domains 
                    and meeting name patterns. The SmartTagProcessor job runs hourly at :30.
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> Save Settings
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Fragment Extraction AI Prompt</h5>
    </div>
    <div class="card-body">
        <p class="text-muted mb-3">
            This prompt instructs the AI on how to extract fragments from source content. 
            Use <code>{{SOURCE_CONTENT}}</code> as a placeholder for the actual source content.
        </p>
        
        <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle"></i>
            <strong>Note:</strong> The JSON response structure is system-controlled. You only need to provide instructions 
            for what types of fragments to extract and how to categorize them. The AI will automatically format 
            the response with <code>title</code>, <code>summary</code>, <code>category</code>, and <code>content</code> fields.
        </div>
        
        <form asp-action="SaveFragmentExtractionPrompt" method="post">
            <input type="hidden" name="templateId" value="@templateId" />
            <div class="mb-3">
                <label for="promptContent" class="form-label">Prompt Template</label>
                <textarea class="form-control font-monospace" 
                          id="promptContent" 
                          name="promptContent" 
                          rows="15" 
                          required>@fragmentExtractionPrompt</textarea>
                <div class="form-text">
                    Describe what types of fragments to extract and how to categorize them. 
                    The system will automatically handle the JSON response format.
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> Save Prompt
                </button>
                <button type="button" class="btn btn-outline-secondary" 
                        onclick="if(confirm('Are you sure you want to reset to the default prompt? This will overwrite your current prompt.')) { document.getElementById('resetForm').submit(); }">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
                </button>
            </div>
        </form>
        
        <form id="resetForm" asp-action="ResetFragmentExtractionPrompt" method="post" class="d-none">
            <input type="hidden" name="templateId" value="@templateId" />
        </form>
    </div>
</div>
