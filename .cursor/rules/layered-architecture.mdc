---
alwaysApply: true
---

# Medley - Layered (N-Tier) Architecture

Model: Layered Architecture
Description: ASP.NET Core 9.0 MVC application using a layered N-tier architecture with PostgreSQL

## Project Structure

```
src/
├── Medley.Web/              # Presentation Layer
├── Medley.Application/      # Application Layer
├── Medley.Domain/           # Domain Layer
├── Medley.Infrastructure/   # Infrastructure Layer
├── Medley.Tests.Web/        # Web/E2E Tests
├── Medley.Tests.Application/# Application Tests
├── Medley.Tests.Domain/     # Domain Tests
└── Medley.Tests.Integration/# Integration Tests
```

## Layers

### Layer: Medley.Web (Presentation)
**Location:** `src/Medley.Web/`
**Project:** `Medley.Web.csproj` (SDK: Microsoft.NET.Sdk.Web)
**Description:** Handles HTTP requests, MVC controllers, Razor views, and user interface

**Key Components:**
- Controllers (e.g., `HomeController`)
- Razor Views (`Views/`)
- ViewModels & DTOs (`Models/`)
- ASP.NET Core Identity UI (`Areas/Identity/`)
- Static files (`wwwroot/`)
- Application entry point (`Program.cs`)

**Dependencies:**
- References `Medley.Application` project
- Uses ASP.NET Core Identity for authentication
- PostgreSQL via Npgsql.EntityFrameworkCore.PostgreSQL

**Technologies:**
- ASP.NET Core 9.0 MVC
- ASP.NET Core Identity
- Razor Views

---

### Layer: Medley.Application (Application)
**Location:** `src/Medley.Application/`
**Project:** `Medley.Application.csproj`
**Description:** Coordinates use cases, orchestrates domain logic, and provides application services

**Key Components:**
- Application Services (to be implemented)
- DTOs (Data Transfer Objects)
- Mappings/AutoMapper profiles
- Command/Query handlers
- Application interfaces

**Dependencies:**
- References `Medley.Domain` project only
- No infrastructure or presentation dependencies

**Technologies:**
- .NET 9.0 Class Library
- RootNamespace: `Medley`

---

### Layer: Medley.Domain (Domain)
**Location:** `src/Medley.Domain/`
**Project:** `Medley.Domain.csproj`
**Description:** Contains core business logic, entities, value objects, and domain services. This is the heart of the application with no external dependencies.

**Key Components:**
- Domain Entities
- Value Objects
- Domain Services
- Domain Events
- Domain Interfaces/Contracts
- Business Rules & Validation

**Dependencies:**
- None (pure domain logic)

**Technologies:**
- .NET 9.0 Class Library
- RootNamespace: `Medley`

---

### Layer: Medley.Infrastructure (Infrastructure)
**Location:** `src/Medley.Infrastructure/`
**Project:** `Medley.Infrastructure.csproj`
**Description:** Handles data persistence, repositories, and external integrations

**Key Components:**
- `Data/ApplicationDbContext.cs` - EF Core DbContext with Identity
- `Migrations/` - EF Core database migrations
- Repository implementations (to be added)
- External service integrations
- Database configurations

**Dependencies:**
- References `Medley.Domain` project
- Microsoft.AspNetCore.Identity.EntityFrameworkCore
- Npgsql.EntityFrameworkCore.PostgreSQL (PostgreSQL provider)
- Microsoft.EntityFrameworkCore.Tools

**Technologies:**
- .NET 9.0 Class Library
- Entity Framework Core 9.0
- PostgreSQL database
- ASP.NET Core Identity for user management
- RootNamespace: `Medley`

---

## Test Layers

### Layer: Medley.Tests.Domain (Domain Unit Tests)
**Location:** `src/Medley.Tests.Domain/`
**Description:** Unit tests for domain entities, value objects, and business logic

**Dependencies:**
- Tests `Medley.Domain`

**Technologies:**
- xUnit
- Should include: FluentAssertions (recommended)

---

### Layer: Medley.Tests.Application (Application Unit Tests)
**Location:** `src/Medley.Tests.Application/`
**Description:** Unit tests for application services with mocked dependencies

**Dependencies:**
- Tests `Medley.Application` and `Medley.Domain`

**Technologies:**
- xUnit
- Should include: Moq, FluentAssertions (recommended)

---

### Layer: Medley.Tests.Integration (Integration Tests)
**Location:** `src/Medley.Tests.Integration/`
**Description:** Integration tests for application + infrastructure layers, testing database interactions

**Dependencies:**
- Tests `Medley.Application`, `Medley.Infrastructure`, and `Medley.Domain`

**Technologies:**
- xUnit
- Should include: EFCore.InMemory or Testcontainers, FluentAssertions (recommended)

---

### Layer: Medley.Tests.Web (Web/E2E Tests)
**Location:** `src/Medley.Tests.Web/`
**Description:** Functional and end-to-end tests for web endpoints and UI workflows

**Dependencies:**
- Tests `Medley.Web`, `Medley.Application`, `Medley.Infrastructure`, and `Medley.Domain`

**Technologies:**
- xUnit
- Should include: Microsoft.AspNetCore.Mvc.Testing, FluentAssertions (recommended)

---

## Dependency Flow

```
Medley.Web (Presentation)
    ↓
Medley.Application
    ↓
Medley.Domain ← Medley.Infrastructure
```

**Key Principles:**
- **Medley.Domain** has no dependencies (pure business logic)
- **Medley.Infrastructure** only depends on Domain
- **Medley.Application** only depends on Domain
- **Medley.Web** depends on Application (and transitively on Domain)
- Infrastructure is registered via Dependency Injection in the Presentation layer

---

## Architecture Rules

1. **Domain Layer Independence:** The Domain layer must not reference any other layer
2. **Infrastructure Isolation:** Infrastructure details should not leak into Application or Domain
3. **Dependency Direction:** Dependencies always point inward toward the Domain
4. **Interface Segregation:** Infrastructure implementations should be abstracted via interfaces defined in Domain or Application
5. **Separation of Concerns:** Each layer has distinct responsibilities and should not perform tasks of other layers

---

## Technology Stack

- **Framework:** .NET 9.0
- **Web Framework:** ASP.NET Core 9.0 MVC
- **ORM:** Entity Framework Core 9.0
- **Database:** PostgreSQL (via Npgsql)
- **Authentication:** ASP.NET Core Identity
- **Testing:** xUnit
- **Root Namespace:** Medley
