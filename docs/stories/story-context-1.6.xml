<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>6</storyId>
    <title>AWS Integration Setup</title>
    <status>Draft</status>
    <generatedAt>2025-10-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-1.6.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer</asA>
    <iWant>to configure AWS services for cloud storage and AI processing</iWant>
    <soThat>the platform can scale and integrate with Claude 4.5 via Bedrock</soThat>
    <tasks>
      <task id="1" ac="1,4">Configure AWS SDK and Credentials
        <subtask id="1.1">Install AWS SDK NuGet packages (AWSSDK.Core, AWSSDK.S3, AWSSDK.BedrockRuntime)</subtask>
        <subtask id="1.2">Create strongly-typed configuration classes (AwsSettings, S3Settings, BedrockSettings, FileStorageSettings)</subtask>
        <subtask id="1.3">Add FileStorageProvider enum (Local, S3) and provider selection configuration</subtask>
        <subtask id="1.4">Configure AWS credentials using appsettings.json for development</subtask>
        <subtask id="1.5">Set up AWS credentials provider with environment variable support</subtask>
        <subtask id="1.6">Configure AWS region settings and service endpoints</subtask>
        <subtask id="1.7">Register strongly-typed configuration classes using IOptions pattern</subtask>
        <subtask id="1.8">Register AWS services in dependency injection container with conditional registration</subtask>
      </task>
      <task id="2" ac="5">Implement File Storage Service Abstraction
        <subtask id="2.1">Create IFileStorageService interface in Application layer</subtask>
        <subtask id="2.2">Implement LocalFileStorageService in Infrastructure layer for development</subtask>
        <subtask id="2.3">Implement S3FileStorageService in Infrastructure layer for production</subtask>
        <subtask id="2.4">Add file upload functionality with content type handling (both implementations)</subtask>
        <subtask id="2.5">Implement file download with stream support (both implementations)</subtask>
        <subtask id="2.6">Add file deletion and existence checking (both implementations)</subtask>
        <subtask id="2.7">Implement pre-signed URL generation (S3) and temporary URL generation (Local)</subtask>
        <subtask id="2.8">Add provider selection logic based on configuration setting</subtask>
      </task>
      <task id="3" ac="2">Configure S3 Bucket and Storage
        <subtask id="3.1">Add S3 configuration to appsettings.json (bucket name, region, folder structure)</subtask>
        <subtask id="3.2">Bind S3Settings configuration class using IOptions&lt;S3Settings&gt;</subtask>
        <subtask id="3.3">Implement bucket initialization and validation</subtask>
        <subtask id="3.4">Configure S3 bucket policies for application access</subtask>
        <subtask id="3.5">Set up folder structure conventions for organized storage</subtask>
        <subtask id="3.6">Configure S3 lifecycle policies for cost optimization</subtask>
      </task>
      <task id="4" ac="3">Configure AWS Bedrock Client
        <subtask id="4.1">Install AWSSDK.BedrockRuntime NuGet package</subtask>
        <subtask id="4.2">Add Bedrock configuration to appsettings.json (model ID, region, parameters)</subtask>
        <subtask id="4.3">Bind BedrockSettings configuration class using IOptions&lt;BedrockSettings&gt;</subtask>
        <subtask id="4.4">Create IAiProcessingService interface in Application layer</subtask>
        <subtask id="4.5">Implement BedrockAiService in Infrastructure layer with injected IOptions&lt;BedrockSettings&gt;</subtask>
        <subtask id="4.6">Configure Claude 4.5 model ID and parameters from settings</subtask>
        <subtask id="4.7">Implement basic prompt invocation with error handling</subtask>
        <subtask id="4.8">Add response parsing and validation</subtask>
      </task>
      <task id="5" ac="6">Implement AWS Health Checks
        <subtask id="5.1">Create S3 health check to verify bucket access</subtask>
        <subtask id="5.2">Create Bedrock health check to verify API connectivity</subtask>
        <subtask id="5.3">Register health checks in ASP.NET Core health check system</subtask>
        <subtask id="5.4">Add health check endpoints to monitoring dashboard</subtask>
        <subtask id="5.5">Configure health check failure alerts and logging</subtask>
      </task>
      <task id="6" ac="Testing">Add Unit and Integration Tests
        <subtask id="6.1">Create unit tests for LocalFileStorageService with mocked file system</subtask>
        <subtask id="6.2">Create unit tests for S3FileStorageService with mocked S3 client</subtask>
        <subtask id="6.3">Create unit tests for IAiProcessingService with mocked Bedrock client</subtask>
        <subtask id="6.4">Create integration tests for local file operations with temp directory</subtask>
        <subtask id="6.5">Create integration tests for S3 operations with test bucket</subtask>
        <subtask id="6.6">Create integration tests for Bedrock API calls with test prompts</subtask>
        <subtask id="6.7">Test provider switching logic with different configuration values</subtask>
        <subtask id="6.8">Add health check integration tests</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">AWS SDK configured for .NET application with proper dependency injection</criterion>
    <criterion id="2">AWS S3 bucket setup for document storage and file uploads</criterion>
    <criterion id="3">AWS Bedrock client configuration for Claude 4.5 access</criterion>
    <criterion id="4">AWS credentials management and security configuration</criterion>
    <criterion id="5">Storage service abstraction layer implemented for file operations</criterion>
    <criterion id="6">Basic AWS service health checks implemented</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epics.md" title="Epic Breakdown" section="Story 1.6: AWS Integration Setup">
        Defines the user story, acceptance criteria, and prerequisites for AWS integration. Story establishes AWS SDK configuration, S3 bucket setup, Bedrock client configuration, credentials management, storage service abstraction, and basic health checks.
      </doc>
      <doc path="docs/tech-spec-epic-1.md" title="Tech Spec: Epic 1" section="AWS Integration (Story 1.6)">
        Specifies AWS S3 for file storage with IFileStorageService abstraction and AWS Bedrock for Claude 4.5 AI processing. Emphasizes interface abstractions allowing provider swapping (S3 ↔ Azure Blob ↔ Local FileSystem).
      </doc>
      <doc path="docs/solution-architecture.md" title="Solution Architecture" section="Technology Stack and Key Interface Abstractions">
        Defines Clean Architecture with interface abstractions for Database, ORM, AI Processing, and File Storage. IFileStorageService allows swapping AWS S3 ↔ Azure Blob Storage ↔ Local FileSystem. IAiProcessingService allows swapping AWS Bedrock ↔ OpenAI ↔ Azure OpenAI ↔ OpenRouter. Emphasizes easy mocking for unit tests and implementation swapping without code changes.
      </doc>
      <doc path="docs/PRD.md" title="Product Requirements Document" section="Functional Requirements - AI Fragment Extraction">
        FR007-FR011 define AI fragment extraction requirements that will use AWS Bedrock integration. System must extract meaningful insights from meeting transcripts using structured LLM prompts, apply keyword detection, process action items, analyze recurring topics, and generate confidence scores.
      </doc>
      <doc path="docs/PRD.md" title="Product Requirements Document" section="Non-Functional Requirements">
        NFR002: Process 10,000+ fragments per hour during peak usage. NFR004: Encrypt all data at rest and in transit using industry-standard encryption (AES-256). NFR007: Implement OAuth 2.0 for secure third-party integrations.
      </doc>
    </docs>
    <code>
      <artifact path="src/Medley.Infrastructure/DependencyInjection.cs" kind="infrastructure" symbol="AddInfrastructure" lines="1-70" reason="Existing DI registration pattern for infrastructure services. Story 1.6 will add AWS service registration here using conditional registration based on FileStorageProvider enum."/>
      <artifact path="src/Medley.Application/Interfaces/IRepository.cs" kind="interface" symbol="IRepository&lt;T&gt;" lines="1-28" reason="Example of existing interface abstraction pattern. Story 1.6 will follow same pattern for IFileStorageService and IAiProcessingService interfaces."/>
      <artifact path="src/Medley.Infrastructure/Data/Repository.cs" kind="service" symbol="Repository&lt;T&gt;" lines="1-38" reason="Example of existing service implementation pattern with constructor injection. Story 1.6 will follow same pattern for LocalFileStorageService, S3FileStorageService, and BedrockAiService."/>
      <artifact path="src/Medley.Application/Interfaces/IBackgroundJobService.cs" kind="interface" symbol="IBackgroundJobService" reason="Example of service interface abstraction from Story 1.5. Story 1.6 follows same pattern for IFileStorageService and IAiProcessingService."/>
      <artifact path="src/Medley.Infrastructure/Services/BackgroundJobService.cs" kind="service" symbol="BackgroundJobService" reason="Example of service implementation from Story 1.5 with constructor injection and interface implementation. Story 1.6 follows same pattern."/>
      <artifact path="src/Medley.Web/appsettings.json" kind="configuration" symbol="appsettings" lines="1-18" reason="Existing configuration structure. Story 1.6 will add FileStorage and AWS sections here with strongly-typed configuration binding."/>
      <artifact path="src/Medley.Application/Enums/FileStorageProvider.cs" kind="enum" symbol="FileStorageProvider" reason="Enum for provider selection (Local, S3) to enable conditional service registration in DependencyInjection.cs."/>
    </code>
    <dependencies>
      <nuget>
        <package name="AWSSDK.Core" version="latest" reason="Core AWS SDK for .NET - required for all AWS service integrations"/>
        <package name="AWSSDK.S3" version="latest" reason="AWS S3 client for file storage operations"/>
        <package name="AWSSDK.BedrockRuntime" version="latest" reason="AWS Bedrock Runtime client for Claude 4.5 AI processing"/>
        <package name="Microsoft.Extensions.Options" version="8.0+" reason="IOptions&lt;T&gt; pattern for strongly-typed configuration"/>
        <package name="Microsoft.Extensions.Options.ConfigurationExtensions" version="8.0+" reason="Configuration binding for IOptions&lt;T&gt;"/>
      </nuget>
      <existing>
        <package name="Microsoft.EntityFrameworkCore" version="8.0+" reason="Already used for database operations - Story 1.6 follows same DI patterns"/>
        <package name="Npgsql.EntityFrameworkCore.PostgreSQL" version="8.0+" reason="Already used for PostgreSQL - Story 1.6 follows same configuration patterns"/>
        <package name="Hangfire" version="1.8.6" reason="Already configured in Story 1.5 - Story 1.6 follows same DI registration patterns"/>
      </existing>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Clean Architecture: AWS services in Medley.Infrastructure, interfaces in Medley.Application, configuration in Medley.Web. All dependencies point inward to Domain layer.</constraint>
    <constraint type="pattern">Interface Abstractions: IFileStorageService and IAiProcessingService must allow easy swapping of implementations. Use IOptions&lt;T&gt; pattern for strongly-typed configuration.</constraint>
    <constraint type="pattern">Provider Pattern: Register IFileStorageService implementation based on FileStorageSettings.Provider value using switch statement in DependencyInjection.cs.</constraint>
    <constraint type="pattern">Constructor Injection: Inject IOptions&lt;FileStorageSettings&gt;, IOptions&lt;S3Settings&gt;, IOptions&lt;BedrockSettings&gt; into service implementations.</constraint>
    <constraint type="security">Never commit AWS credentials to source control. Use environment variables or AWS IAM roles for production. Implement least-privilege IAM policies.</constraint>
    <constraint type="configuration">Development: Use LocalFileStorageService (Provider = "Local"). Production: Use S3FileStorageService (Provider = "S3"). Switch via appsettings.{Environment}.json.</constraint>
    <constraint type="testing">All interfaces must be mockable for unit tests. Use Moq for mocking IAmazonS3 and AmazonBedrockRuntimeClient.</constraint>
    <constraint type="error-handling">Implement retry logic with exponential backoff for transient AWS failures. Use structured logging for all AWS operations.</constraint>
    <constraint type="performance">Configure timeouts for S3 and Bedrock operations. Support 10,000+ fragments/hour processing per PRD NFR002.</constraint>
  </constraints>

  <interfaces>
    <interface name="IFileStorageService" kind="service-interface" signature="Task&lt;string&gt; UploadAsync(Stream content, string fileName, string contentType); Task&lt;Stream&gt; DownloadAsync(string fileKey); Task&lt;bool&gt; DeleteAsync(string fileKey); Task&lt;string&gt; GetDownloadUrlAsync(string fileKey, TimeSpan expiry);" path="src/Medley.Application/Interfaces/IFileStorageService.cs">
      File storage abstraction allowing swapping between LocalFileStorageService and S3FileStorageService based on configuration.
    </interface>
    <interface name="IAiProcessingService" kind="service-interface" signature="Task&lt;FragmentExtractionResult&gt; ExtractFragmentsAsync(string transcript); Task&lt;DocumentGenerationResult&gt; GenerateDocumentAsync(IEnumerable&lt;Fragment&gt; fragments); Task&lt;ClusteringResult&gt; ClusterFragmentsAsync(IEnumerable&lt;Fragment&gt; fragments);" path="src/Medley.Application/Interfaces/IAiProcessingService.cs">
      AI processing abstraction allowing swapping between AWS Bedrock, OpenAI, Azure OpenAI, or OpenRouter based on configuration.
    </interface>
    <interface name="IRepository&lt;T&gt;" kind="existing-interface" signature="Task&lt;T?&gt; GetByIdAsync(Guid id); IQueryable&lt;T&gt; Query(); Task SaveAsync(T entity);" path="src/Medley.Application/Interfaces/IRepository.cs">
      Existing repository pattern to follow for new service interfaces. Demonstrates interface abstraction pattern used throughout application.
    </interface>
    <interface name="IBackgroundJobService" kind="existing-interface" path="src/Medley.Application/Interfaces/IBackgroundJobService.cs">
      Existing service interface from Story 1.5 demonstrating interface abstraction pattern. Story 1.6 follows same pattern for IFileStorageService and IAiProcessingService.
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use xUnit for unit and integration tests. Use Moq for mocking dependencies. Follow existing test patterns in src/tests/ directories. Unit tests in Medley.Tests.Application and Medley.Tests.Infrastructure. Integration tests in Medley.Tests.Integration. Test both LocalFileStorageService and S3FileStorageService implementations. Mock IAmazonS3 and AmazonBedrockRuntimeClient for unit tests. Use real AWS services with test credentials for integration tests (or LocalStack for local testing).
    </standards>
    <locations>
      <location>src/tests/Medley.Tests.Application/Services/</location>
      <location>src/tests/Medley.Tests.Infrastructure/Services/</location>
      <location>src/tests/Medley.Tests.Integration/AWS/</location>
    </locations>
    <ideas>
      <idea ac="1">Test AWS SDK configuration and DI registration. Verify IOptions&lt;T&gt; binding for AwsSettings, S3Settings, BedrockSettings, FileStorageSettings.</idea>
      <idea ac="2">Test S3 bucket initialization and validation. Test file upload/download/delete operations. Test pre-signed URL generation.</idea>
      <idea ac="3">Test Bedrock client configuration. Test prompt invocation with mock responses. Test error handling for API failures.</idea>
      <idea ac="4">Test AWS credentials loading from appsettings.json and environment variables. Test credential validation.</idea>
      <idea ac="5">Test LocalFileStorageService with temp directory. Test S3FileStorageService with mocked IAmazonS3. Test provider switching logic.</idea>
      <idea ac="6">Test S3 health check with accessible and inaccessible buckets. Test Bedrock health check with valid and invalid credentials.</idea>
      <idea ac="Testing">Test all IFileStorageService methods for both implementations. Test IAiProcessingService methods with mocked Bedrock client. Test configuration binding and provider selection.</idea>
    </ideas>
  </tests>
</story-context>
