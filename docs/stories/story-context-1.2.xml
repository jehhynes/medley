<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.2</storyId>
    <title>User Authentication and Authorization System</title>
    <status>Ready</status>
    <generatedAt>2025-10-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-1.2.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to implement user authentication and role-based access control</iWant>
    <soThat>only authorized users can access organizational data and generated documentation</soThat>
    <tasks>
      <task id="1" acs="1,2">
        <title>Configure ASP.NET Core Identity</title>
        <subtasks>
          <subtask>Add Microsoft.AspNetCore.Identity.EntityFrameworkCore NuGet package</subtask>
          <subtask>Create IdentityUser and IdentityRole entities extending base classes</subtask>
          <subtask>Configure Identity services in Program.cs with password policies</subtask>
          <subtask>Create database migration for Identity tables</subtask>
          <subtask>Seed initial roles (Admin, Editor, Viewer)</subtask>
        </subtasks>
      </task>
      <task id="2" acs="1,3">
        <title>Implement User Registration</title>
        <subtasks>
          <subtask>Create RegisterViewModel with validation attributes</subtask>
          <subtask>Implement AuthController.Register GET action (display form)</subtask>
          <subtask>Implement AuthController.Register POST action (process registration)</subtask>
          <subtask>Create Register.cshtml view with Bootstrap form</subtask>
          <subtask>Add password strength validation (min 8 chars, uppercase, lowercase, digit, special char)</subtask>
          <subtask>Add email confirmation requirement</subtask>
        </subtasks>
      </task>
      <task id="3" acs="1,5">
        <title>Implement User Login</title>
        <subtasks>
          <subtask>Create LoginViewModel with validation</subtask>
          <subtask>Implement AuthController.Login GET action</subtask>
          <subtask>Implement AuthController.Login POST action with SignInManager</subtask>
          <subtask>Create Login.cshtml view with Bootstrap form</subtask>
          <subtask>Configure cookie authentication with sliding expiration (30 minutes)</subtask>
          <subtask>Add "Remember Me" functionality</subtask>
          <subtask>Implement logout functionality</subtask>
        </subtasks>
      </task>
      <task id="4" acs="2">
        <title>Implement Role-Based Authorization</title>
        <subtasks>
          <subtask>Add [Authorize(Roles = "Admin")] attributes to admin-only controllers</subtask>
          <subtask>Add [Authorize(Roles = "Admin,Editor")] for editor actions</subtask>
          <subtask>Create authorization policies in Program.cs</subtask>
          <subtask>Implement role assignment in user management interface</subtask>
          <subtask>Test role-based access restrictions</subtask>
        </subtasks>
      </task>
      <task id="5" acs="4">
        <title>Create User Management Interface</title>
        <subtasks>
          <subtask>Create UserManagementController (Admin only)</subtask>
          <subtask>Implement user list view with search and filtering</subtask>
          <subtask>Implement user edit form for role assignment</subtask>
          <subtask>Implement user deletion with confirmation</subtask>
          <subtask>Add user status indicators (active, locked out)</subtask>
        </subtasks>
      </task>
      <task id="6" acs="6">
        <title>Implement Audit Logging</title>
        <subtasks>
          <subtask>Create AuditLog entity (UserId, Action, Timestamp, IpAddress, Details)</subtask>
          <subtask>Add database migration for AuditLog table</subtask>
          <subtask>Log successful login events</subtask>
          <subtask>Log failed login attempts</subtask>
          <subtask>Log logout events</subtask>
          <subtask>Log role changes and user management actions</subtask>
          <subtask>Create audit log viewer for administrators</subtask>
        </subtasks>
      </task>
      <task id="7" acs="7">
        <title>Prepare OAuth 2.0 Foundation</title>
        <subtasks>
          <subtask>Add Microsoft.AspNetCore.Authentication.OAuth NuGet package</subtask>
          <subtask>Configure OAuth authentication services in Program.cs</subtask>
          <subtask>Create placeholder for external provider configuration</subtask>
          <subtask>Document OAuth integration points for future Fellow.ai/GitHub integration</subtask>
          <subtask>Add external login button placeholders in UI</subtask>
        </subtasks>
      </task>
      <task id="8" acs="all">
        <title>Testing</title>
        <subtasks>
          <subtask>Unit tests for AuthController actions</subtask>
          <subtask>Integration tests for Identity database operations</subtask>
          <subtask>Test password policy enforcement</subtask>
          <subtask>Test role-based authorization on protected routes</subtask>
          <subtask>Test session timeout and cookie expiration</subtask>
          <subtask>Test audit logging for all authentication events</subtask>
          <subtask>Manual testing of complete registration and login flow</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">ASP.NET Core Identity system implemented with user registration and login</criterion>
    <criterion id="2">Role-based authorization configured (Admin, Editor, Viewer roles)</criterion>
    <criterion id="3">Password requirements and security policies enforced</criterion>
    <criterion id="4">User management interface for administrators implemented</criterion>
    <criterion id="5">Session management and timeout configuration applied</criterion>
    <criterion id="6">Basic audit logging for authentication events implemented</criterion>
    <criterion id="7">OAuth 2.0 foundation prepared for future third-party integrations</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Tech Spec: Epic 1 - Foundation &amp; Core Infrastructure</title>
        <section>Story 1.2: User Authentication and Authorization System</section>
        <snippet>Configure ASP.NET Core Identity with role-based authorization (Admin, Editor, Viewer). Implement user management interfaces, audit logging for auth events, and OAuth 2.0 foundation for future integrations.</snippet>
      </doc>
      <doc>
        <path>docs/solution-architecture.md</path>
        <title>Solution Architecture Document</title>
        <section>5. Authentication and Authorization</section>
        <snippet>ASP.NET Core Identity for authentication with role-based access control. Password hashing via PBKDF2, HTTPS enforcement, anti-forgery tokens, secure cookie configuration (HttpOnly, Secure, SameSite).</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Medley - Epic Breakdown</title>
        <section>Story 1.2: User Authentication and Authorization System</section>
        <snippet>Implement user authentication and role-based access control so that only authorized users can access organizational data. Prerequisites: Story 1.1 completed.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Medley Product Requirements Document</title>
        <section>Non-Functional Requirements</section>
        <snippet>NFR007: Implement OAuth 2.0 for secure third-party integrations and API access. NFR008: Maintain comprehensive audit logs for all data access and modification operations.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/Medley.Infrastructure/Data/ApplicationDbContext.cs</path>
        <kind>database-context</kind>
        <symbol>ApplicationDbContext</symbol>
        <lines>all</lines>
        <reason>Already extends IdentityDbContext - foundation for Identity system is in place. Need to add AuditLog DbSet and configure custom User entity.</reason>
      </artifact>
      <artifact>
        <path>src/Medley.Web/Program.cs</path>
        <kind>configuration</kind>
        <symbol>Program.Main</symbol>
        <lines>all</lines>
        <reason>Identity services already configured with AddDefaultIdentity. Need to enhance with custom password policies, role support (AddRoles), and authorization policies.</reason>
      </artifact>
      <artifact>
        <path>src/Medley.Infrastructure/Migrations/20251008103435_CreateIdentitySchema.cs</path>
        <kind>migration</kind>
        <symbol>CreateIdentitySchema</symbol>
        <lines>all</lines>
        <reason>Identity tables already created in database. This story will add AuditLog table and seed roles.</reason>
      </artifact>
      <artifact>
        <path>src/Medley.Web/Controllers/HomeController.cs</path>
        <kind>controller</kind>
        <symbol>HomeController</symbol>
        <lines>all</lines>
        <reason>Existing controller pattern to follow for AuthController and UserManagementController implementation.</reason>
      </artifact>
      <artifact>
        <path>src/Medley.Infrastructure/Data/Repository.cs</path>
        <kind>repository</kind>
        <symbol>Repository&lt;T&gt;</symbol>
        <lines>all</lines>
        <reason>Generic repository pattern already implemented. Use for AuditLog entity persistence.</reason>
      </artifact>
      <artifact>
        <path>src/Medley.Application/Interfaces/IRepository.cs</path>
        <kind>interface</kind>
        <symbol>IRepository&lt;T&gt;</symbol>
        <lines>all</lines>
        <reason>Repository interface abstraction. Create IAuditLogService following this pattern.</reason>
      </artifact>
    </code>
    <dependencies>
      <nuget>
        <package name="Microsoft.AspNetCore.Identity.EntityFrameworkCore" version="8.0+" status="installed" />
        <package name="Microsoft.AspNetCore.Identity.UI" version="8.0+" status="installed" />
        <package name="Microsoft.EntityFrameworkCore" version="8.0+" status="installed" />
        <package name="Npgsql.EntityFrameworkCore.PostgreSQL" version="8.0+" status="installed" />
        <package name="Serilog.AspNetCore" version="latest" status="installed" />
        <package name="Microsoft.AspNetCore.Authentication.OAuth" version="8.0+" status="to-add" note="Required for AC #7 - OAuth 2.0 foundation" />
      </nuget>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Clean Architecture: Identity at Infrastructure layer, UI in Presentation, services in Application, User entity in Domain extending IdentityUser</constraint>
    <constraint type="security">Password hashing via PBKDF2 (Identity default), HTTPS enforcement, anti-forgery tokens on all forms, secure cookie configuration (HttpOnly, Secure, SameSite)</constraint>
    <constraint type="pattern">Repository pattern for AuditLog persistence, dependency injection for all services, interface abstractions for testability</constraint>
    <constraint type="testing">Unit tests for controllers with mocked dependencies, integration tests for database operations, test coverage for all acceptance criteria</constraint>
    <constraint type="ui">Bootstrap 5.3 for styling, server-side Razor views, responsive design, WCAG AA accessibility compliance</constraint>
    <constraint type="configuration">Password policies: min 8 chars, uppercase, lowercase, digit, special char. Session timeout: 30 minutes sliding expiration. Email confirmation required.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>UserManager&lt;IdentityUser&gt;</name>
      <kind>service</kind>
      <signature>Built-in ASP.NET Core Identity service for user management operations (CreateAsync, FindByEmailAsync, AddToRoleAsync, etc.)</signature>
      <path>Microsoft.AspNetCore.Identity</path>
    </interface>
    <interface>
      <name>SignInManager&lt;IdentityUser&gt;</name>
      <kind>service</kind>
      <signature>Built-in ASP.NET Core Identity service for authentication operations (PasswordSignInAsync, SignOutAsync, etc.)</signature>
      <path>Microsoft.AspNetCore.Identity</path>
    </interface>
    <interface>
      <name>RoleManager&lt;IdentityRole&gt;</name>
      <kind>service</kind>
      <signature>Built-in ASP.NET Core Identity service for role management (CreateAsync, RoleExistsAsync, etc.)</signature>
      <path>Microsoft.AspNetCore.Identity</path>
    </interface>
    <interface>
      <name>IRepository&lt;AuditLog&gt;</name>
      <kind>repository</kind>
      <signature>Generic repository interface for AuditLog entity persistence (SaveAsync, Query, GetAsync, etc.)</signature>
      <path>src/Medley.Application/Interfaces/IRepository.cs</path>
    </interface>
    <interface>
      <name>IAuditLogService</name>
      <kind>service</kind>
      <signature>Application service for audit logging operations (LogLoginAsync, LogLogoutAsync, LogRoleChangeAsync, etc.) - to be created</signature>
      <path>src/Medley.Application/Interfaces/IAuditLogService.cs</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      xUnit testing framework with Moq for mocking. Unit tests in Medley.Tests.Web for controllers, Medley.Tests.Application for services. Integration tests in Medley.Tests.Integration for database operations. Test database using PostgreSQL with DatabaseFixture for isolation. Follow AAA pattern (Arrange, Act, Assert). Mock all external dependencies using interfaces.
    </standards>
    <locations>
      <location>src/tests/Medley.Tests.Web/Controllers/</location>
      <location>src/tests/Medley.Tests.Application/Services/</location>
      <location>src/tests/Medley.Tests.Infrastructure/Data/</location>
      <location>src/tests/Medley.Tests.Integration/</location>
    </locations>
    <ideas>
      <idea ac="1">Test user registration with valid data creates user in database</idea>
      <idea ac="1">Test user login with correct credentials succeeds and creates session</idea>
      <idea ac="1">Test user login with incorrect credentials fails with appropriate error</idea>
      <idea ac="2">Test Admin role can access UserManagement controller</idea>
      <idea ac="2">Test Editor role cannot access UserManagement controller</idea>
      <idea ac="2">Test Viewer role has read-only access</idea>
      <idea ac="3">Test password validation rejects weak passwords (no uppercase, too short, etc.)</idea>
      <idea ac="3">Test password validation accepts strong passwords meeting all requirements</idea>
      <idea ac="4">Test admin can view user list and assign roles</idea>
      <idea ac="4">Test admin can delete users with confirmation</idea>
      <idea ac="5">Test session expires after 30 minutes of inactivity</idea>
      <idea ac="5">Test "Remember Me" extends session duration</idea>
      <idea ac="6">Test successful login creates audit log entry with timestamp and IP</idea>
      <idea ac="6">Test failed login attempt creates audit log entry</idea>
      <idea ac="6">Test role change creates audit log entry</idea>
      <idea ac="7">Test OAuth configuration is present in Program.cs</idea>
      <idea ac="7">Test external login buttons are present in UI (placeholder)</idea>
    </ideas>
  </tests>
</story-context>
