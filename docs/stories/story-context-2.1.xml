<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.1</storyId>
    <title>Integration Management Interface</title>
    <status>Draft</status>
    <generatedAt>2025-10-22</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-2.1.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system administrator</asA>
    <iWant>to configure connections to external tools through a web interface</iWant>
    <soThat>I can easily manage data sources without technical configuration</soThat>
    <tasks>
      <task id="1" acs="1,2,4,5">Create IntegrationController and Views
        <subtask id="1.1">Create IntegrationController with CRUD action methods (Index, Create, Edit, Delete)</subtask>
        <subtask id="1.2">Create Integration/Index.cshtml view with list display and search/filter UI</subtask>
        <subtask id="1.3">Create Integration/Create.cshtml view with form for new integrations</subtask>
        <subtask id="1.4">Create Integration/Edit.cshtml view with form for editing integrations</subtask>
        <subtask id="1.5">Implement form validation using ASP.NET Core model validation</subtask>
        <subtask id="1.6">Add client-side validation with jQuery Unobtrusive Validation</subtask>
        <subtask id="1.7">Implement error handling and user-friendly error messages</subtask>
        <subtask id="1.8">Add search and filtering functionality to Index view</subtask>
      </task>
      <task id="2" acs="1,4,7">Implement Integration Service Layer
        <subtask id="2.1">Create IIntegrationService interface in Application layer</subtask>
        <subtask id="2.2">Implement IntegrationService with CRUD operations</subtask>
        <subtask id="2.3">Add integration validation logic (API key format, URL validation)</subtask>
        <subtask id="2.4">Implement connection testing functionality</subtask>
        <subtask id="2.5">Add error handling and logging for integration operations</subtask>
        <subtask id="2.6">Implement integration health check logic</subtask>
        <subtask id="2.7">Register service in DI container</subtask>
      </task>
      <task id="3" acs="3,7">Add Real-time Status Updates with SignalR
        <subtask id="3.1">Create IntegrationStatusHub SignalR hub</subtask>
        <subtask id="3.2">Implement status broadcasting from service layer</subtask>
        <subtask id="3.3">Add JavaScript client code for receiving status updates</subtask>
        <subtask id="3.4">Update UI dynamically when status changes</subtask>
        <subtask id="3.5">Add connection state indicators (connected, error, disconnected)</subtask>
        <subtask id="3.6">Implement automatic reconnection logic</subtask>
      </task>
      <task id="4" acs="6">Implement Role-Based Access Control
        <subtask id="4.1">Add [Authorize(Roles = "Admin")] attribute to IntegrationController</subtask>
        <subtask id="4.2">Create access denied view for non-admin users</subtask>
        <subtask id="4.3">Hide integration management menu for non-admin users</subtask>
        <subtask id="4.4">Add role-based UI element visibility in views</subtask>
        <subtask id="4.5">Test access control with different user roles</subtask>
      </task>
      <task id="5" acs="3,7">Add Integration Status Monitoring
        <subtask id="5.1">Create background job for periodic health checks using Hangfire</subtask>
        <subtask id="5.2">Implement health check logic for each integration type</subtask>
        <subtask id="5.3">Update integration status in database based on health check results</subtask>
        <subtask id="5.4">Trigger SignalR notifications on status changes</subtask>
        <subtask id="5.5">Add manual "Test Connection" button to UI</subtask>
        <subtask id="5.6">Display last health check timestamp in UI</subtask>
      </task>
      <task id="6" acs="all">Testing and Validation
        <subtask id="6.1">Write unit tests for IntegrationService</subtask>
        <subtask id="6.2">Write integration tests for IntegrationController</subtask>
        <subtask id="6.3">Test form validation with invalid inputs</subtask>
        <subtask id="6.4">Test real-time status updates with SignalR</subtask>
        <subtask id="6.5">Test role-based access control</subtask>
        <subtask id="6.6">Test search and filtering functionality</subtask>
        <subtask id="6.7">Perform accessibility testing (WCAG AA compliance)</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Integration management page with add/edit/delete functionality for connections</criterion>
    <criterion id="2">Form validation for integration configuration fields (API keys, URLs, scopes)</criterion>
    <criterion id="3">Integration status indicators (connected, error, disconnected) with real-time updates</criterion>
    <criterion id="4">Basic error handling and user feedback for configuration issues</criterion>
    <criterion id="5">Integration list view with search and filtering capabilities</criterion>
    <criterion id="6">Role-based access control (Admin only for integration management)</criterion>
    <criterion id="7">Integration health monitoring with automatic status checks</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epics.md" title="Epic Breakdown" section="Story 2.1: Integration Management Interface">
        Defines user story: system administrator wants to configure connections to external tools through web interface. Includes 7 acceptance criteria covering CRUD operations, form validation, real-time status updates, error handling, search/filtering, role-based access control, and health monitoring.
      </doc>
      <doc path="docs/tech-spec-epic-2.md" title="Tech Spec Epic 2" section="MVC Controllers and Views">
        Specifies IntegrationController endpoints: GET/POST /Integrations for CRUD, /Integrations/{id}/Status for status page, POST /Integrations/{id}/Sync for manual sync, GET /Integrations/{id}/Data for ingested data. Views use server-rendered pages with SignalR for real-time updates.
      </doc>
      <doc path="docs/tech-spec-epic-2.md" title="Tech Spec Epic 2" section="Service Interfaces">
        Defines IMeetingDataService and ICodeDataService interfaces for external integrations with TestConnectionAsync() and GetConnectionStatusAsync() methods for health monitoring.
      </doc>
      <doc path="docs/solution-architecture.md" title="Solution Architecture" section="Application Architecture">
        Clean Architecture pattern: IntegrationController in Presentation layer calls IIntegrationService in Application layer, which coordinates IRepository operations. Integration entity in Domain layer with no external dependencies.
      </doc>
      <doc path="docs/solution-architecture.md" title="Solution Architecture" section="UI/UX Architecture">
        Bootstrap 5.3 for responsive UI with auto dark/light mode. Server-side rendering with ASP.NET Core MVC and Razor views. HTMX for dynamic interactions without full page reloads.
      </doc>
      <doc path="docs/PRD.md" title="Product Requirements Document" section="Data Ingestion & Integration">
        FR001: Integrate with Fellow.ai via API as primary data source. FR002-FR004: Connect to Slack, GitHub, Jira. FR006: Provide webhook endpoints for real-time data ingestion. Integration management is foundation for all data sources.
      </doc>
    </docs>
    <code>
      <artifact path="src/Medley.Domain/Entities/Integration.cs" kind="entity" symbol="Integration" reason="Existing Integration entity with Type, DisplayName, ConfigurationJson, LastModifiedAt properties. Inherits from BusinessEntity which includes OrganizationId for multi-tenancy."/>
      <artifact path="src/Medley.Domain/Entities/BaseEntity.cs" kind="entity" symbol="BaseEntity" reason="Base entity with Guid Id property. All entities inherit from this."/>
      <artifact path="src/Medley.Domain/Entities/BusinessEntity.cs" kind="entity" symbol="BusinessEntity" reason="Business entity base class with OrganizationId for multi-tenant support. Integration inherits from this."/>
      <artifact path="src/Medley.Application/Services/UserAuditLogService.cs" kind="service" symbol="UserAuditLogService" reason="Example service pattern using IRepository injection, async operations, and proper error handling. Follow this pattern for IntegrationService."/>
      <artifact path="src/Medley.Application/Interfaces/IRepository.cs" kind="interface" symbol="IRepository&lt;T&gt;" reason="Generic repository interface with GetByIdAsync, Query, and SaveAsync methods. Use for Integration data access."/>
      <artifact path="src/Medley.Web/Controllers/HomeController.cs" kind="controller" symbol="HomeController" reason="Example controller pattern with dependency injection, async actions, and view model usage. Follow this pattern for IntegrationController."/>
      <artifact path="src/Medley.Web/Views/Home/Index.cshtml" kind="view" reason="Example Razor view using Bootstrap 5.3 cards, responsive grid, CoreUI icons. Follow this pattern for Integration views."/>
      <artifact path="src/Medley.Web/Views/Shared/_Layout.cshtml" kind="layout" lines="1-200" reason="Main layout with CoreUI sidebar navigation, header with theme switcher, and responsive design. Add Integration menu item here."/>
      <artifact path="src/Medley.Web/Program.cs" kind="configuration" lines="1-150" reason="Application startup with Identity configuration, authorization policies, Hangfire dashboard, and health checks. Register IntegrationService and SignalR hub here."/>
      <artifact path="src/Medley.Infrastructure/Services/BackgroundJobService.cs" kind="service" symbol="BackgroundJobService" reason="Hangfire background job service implementation. Use for scheduling integration health checks."/>
    </code>
    <dependencies>
      <dotnet>
        <package name="Microsoft.AspNetCore.Identity.EntityFrameworkCore" version="8.0+" reason="ASP.NET Core Identity for authentication and role-based authorization"/>
        <package name="Microsoft.EntityFrameworkCore" version="8.0+" reason="Entity Framework Core for data access"/>
        <package name="Npgsql.EntityFrameworkCore.PostgreSQL" version="8.0+" reason="PostgreSQL database provider"/>
        <package name="Hangfire" version="1.8+" reason="Background job processing for health checks"/>
        <package name="Microsoft.AspNetCore.SignalR" version="8.0+" reason="Real-time status updates"/>
        <package name="Serilog" version="3.0+" reason="Structured logging"/>
        <package name="xUnit" version="2.4+" reason="Unit testing framework"/>
        <package name="Moq" version="4.18+" reason="Mocking framework for tests"/>
      </dotnet>
      <frontend>
        <library name="CoreUI" version="5.4.3" reason="Bootstrap-based UI framework with sidebar and components"/>
        <library name="CoreUI Icons" version="latest" reason="Icon library for UI elements"/>
        <library name="jQuery" version="3.6+" reason="Client-side validation and AJAX"/>
        <library name="SignalR Client" version="8.0+" reason="JavaScript client for real-time updates"/>
      </frontend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Clean Architecture: IntegrationController (Presentation) → IIntegrationService (Application) → IRepository&lt;Integration&gt; (Infrastructure). No direct database access from controllers.</constraint>
    <constraint type="security">Admin role required for all integration management operations. Use [Authorize(Roles = "Admin")] attribute on controller.</constraint>
    <constraint type="validation">Server-side validation required for all form inputs. Client-side validation for UX enhancement only.</constraint>
    <constraint type="error-handling">All exceptions must be logged with Serilog. User-friendly error messages displayed in UI. No sensitive information in error messages.</constraint>
    <constraint type="testing">Unit tests required for service layer with mocked dependencies. Integration tests for controller actions. Accessibility testing for WCAG AA compliance.</constraint>
    <constraint type="ui">Bootstrap 5.3 responsive design. CoreUI components for consistency. Support auto dark/light mode theme switching.</constraint>
    <constraint type="performance">Sub-2-second response times for all UI operations. Background jobs for long-running health checks.</constraint>
    <constraint type="data">ConfigurationJson field encrypted at rest in Infrastructure layer. API keys never logged or displayed in plain text.</constraint>
  </constraints>

  <interfaces>
    <interface name="IIntegrationService" kind="application-service">
      <signature>
        Task&lt;Integration?&gt; GetByIdAsync(Guid id);
        IQueryable&lt;Integration&gt; Query();
        Task SaveAsync(Integration integration);
        Task DeleteAsync(Guid id);
        Task&lt;bool&gt; TestConnectionAsync(Guid integrationId);
        Task&lt;ConnectionStatus&gt; GetConnectionStatusAsync(Guid integrationId);
        Task UpdateHealthStatusAsync(Guid integrationId);
      </signature>
      <path>src/Medley.Application/Interfaces/IIntegrationService.cs</path>
    </interface>
    <interface name="IRepository&lt;Integration&gt;" kind="data-access">
      <signature>
        Task&lt;Integration?&gt; GetByIdAsync(Guid id);
        IQueryable&lt;Integration&gt; Query();
        Task SaveAsync(Integration entity);
      </signature>
      <path>src/Medley.Application/Interfaces/IRepository.cs</path>
    </interface>
    <interface name="IntegrationStatusHub" kind="signalr-hub">
      <signature>
        Task SendStatusUpdate(Guid integrationId, string status, string message);
        Task SendHealthCheckResult(Guid integrationId, bool isHealthy, DateTime timestamp);
      </signature>
      <path>src/Medley.Web/Hubs/IntegrationStatusHub.cs</path>
    </interface>
    <interface name="IntegrationController" kind="mvc-controller">
      <signature>
        GET /Integration/Index - List all integrations
        GET /Integration/Create - Show create form
        POST /Integration/Create - Process new integration
        GET /Integration/Edit/{id} - Show edit form
        POST /Integration/Edit/{id} - Update integration
        POST /Integration/Delete/{id} - Delete integration
        POST /Integration/TestConnection/{id} - Test connection
      </signature>
      <path>src/Medley.Web/Controllers/IntegrationController.cs</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      xUnit testing framework with Moq for mocking dependencies. Unit tests in src/Medley.Tests.Application for service layer with 80%+ code coverage. Integration tests in src/Medley.Tests.Integration for controller actions with real database context. Accessibility testing using automated tools for WCAG AA compliance. Test naming convention: MethodName_Scenario_ExpectedResult.
    </standards>
    <locations>
      <location>src/Medley.Tests.Application/Services/IntegrationServiceTests.cs</location>
      <location>src/Medley.Tests.Web/Controllers/IntegrationControllerTests.cs</location>
      <location>src/Medley.Tests.Integration/IntegrationManagementTests.cs</location>
    </locations>
    <ideas>
      <idea ac="1">Test CRUD operations: Create integration with valid data, retrieve by ID, update configuration, delete integration. Verify database persistence.</idea>
      <idea ac="2">Test form validation: Submit form with missing required fields, invalid API key format, invalid URL format. Verify validation errors displayed.</idea>
      <idea ac="3">Test real-time status updates: Trigger status change, verify SignalR message sent, verify UI updates dynamically. Test reconnection logic.</idea>
      <idea ac="4">Test error handling: Simulate database error, API connection failure, invalid configuration. Verify user-friendly error messages and logging.</idea>
      <idea ac="5">Test search and filtering: Search by integration name, filter by type, filter by status. Verify correct results returned.</idea>
      <idea ac="6">Test role-based access: Access as Admin (allowed), Editor (denied), Viewer (denied). Verify authorization enforcement.</idea>
      <idea ac="7">Test health monitoring: Schedule background job, execute health check, update status in database, trigger SignalR notification. Verify manual test connection button.</idea>
    </ideas>
  </tests>
</story-context>
