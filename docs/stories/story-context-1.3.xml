<story-context id="story-1.3-vector-database-setup" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.3</storyId>
    <title>Vector Database Setup with pgvector</title>
    <status>Draft</status>
    <generatedAt>2025-10-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-1.3.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>configure PostgreSQL with pgvector extension for semantic similarity operations</iWant>
    <soThat>I can perform efficient similarity matching and clustering of fragments</soThat>
    <tasks>
      <task id="1" ac="1">Install and Configure pgvector Extension</task>
      <task id="2" ac="2">Add Vector Support to Fragment Entity</task>
      <task id="3" ac="3">Implement Vector Indexing Strategy</task>
      <task id="4" ac="4">Create and Test Database Migration</task>
      <task id="5" ac="2,5">Implement Vector Repository Methods</task>
      <task id="6" ac="5">Performance Testing and Validation</task>
      <task id="7" ac="6">Connection Configuration and Verification</task>
      <task id="8" ac="all">Testing and Documentation</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">pgvector extension installed and configured on local PostgreSQL instance</criterion>
    <criterion id="2">Vector column setup for fragment embeddings in database schema</criterion>
    <criterion id="3">Indexing strategy implemented for vector similarity searches (HNSW or IVFFlat)</criterion>
    <criterion id="4">Database migration scripts created for vector schema</criterion>
    <criterion id="5">Performance testing completed for vector operations with sample data</criterion>
    <criterion id="6">Connection string configuration verified for vector operations</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Tech Spec: Epic 1 - Foundation &amp; Core Infrastructure</title>
        <section>Data Models (Epic 1)</section>
        <snippet>Fragment entity prepared for future epics with Vector Embedding property. pgvector extension provides native PostgreSQL vector operations. HNSW indexing recommended for high-dimensional vectors with &lt;1M records.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Medley - Epic Breakdown</title>
        <section>Story 1.3: Vector Database Setup with pgvector</section>
        <snippet>Configure PostgreSQL with pgvector extension for semantic similarity operations. Includes vector column setup, indexing strategy (HNSW or IVFFlat), database migrations, and performance testing with sample data.</snippet>
      </doc>
      <doc>
        <path>docs/solution-architecture.md</path>
        <title>Solution Architecture Document</title>
        <section>2.1 Architecture Pattern - Clean Architecture</section>
        <snippet>Clean Architecture monolith with dependency inversion. Domain layer has no dependencies. Infrastructure implements interfaces defined in Application layer. Database and ORM abstracted through IDbContextFactory and IRepository interfaces.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Medley Product Requirements Document</title>
        <section>Non-Functional Requirements</section>
        <snippet>NFR002: Scalability - Process 10,000+ fragments per hour during peak usage. NFR001: Performance - Sub-2-second response times for document generation and review interfaces.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/Medley.Infrastructure/Data/ApplicationDbContext.cs</path>
        <kind>DbContext</kind>
        <symbol>ApplicationDbContext</symbol>
        <lines>1-27</lines>
        <reason>Main EF Core DbContext - needs to register Fragment entity and FragmentConfiguration for vector support</reason>
      </artifact>
      <artifact>
        <path>src/Medley.Infrastructure/Data/Repository.cs</path>
        <kind>Repository</kind>
        <symbol>Repository&lt;T&gt;</symbol>
        <lines>1-40</lines>
        <reason>Generic repository implementation - base pattern for FragmentRepository with vector similarity methods</reason>
      </artifact>
      <artifact>
        <path>src/Medley.Application/Interfaces/IRepository.cs</path>
        <kind>Interface</kind>
        <symbol>IRepository&lt;T&gt;</symbol>
        <lines>1-27</lines>
        <reason>Repository interface - needs extension for IFragmentRepository with vector similarity methods</reason>
      </artifact>
      <artifact>
        <path>src/Medley.Domain/Entities/User.cs</path>
        <kind>Entity</kind>
        <symbol>User</symbol>
        <lines>1-32</lines>
        <reason>Example entity pattern - Fragment entity should follow similar structure with base properties</reason>
      </artifact>
    </code>
    <dependencies>
      <nuget>
        <package name="Npgsql.EntityFrameworkCore.PostgreSQL" version="9.0+" note="Already installed from Story 1.1" />
        <package name="Pgvector.EntityFrameworkCore" version="latest" note="Required for pgvector support in EF Core" />
        <package name="Microsoft.EntityFrameworkCore.Tools" version="9.0+" note="For migration generation" />
      </nuget>
      <postgresql>
        <extension name="pgvector" version="0.5.0+" note="PostgreSQL extension for vector operations" />
      </postgresql>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Clean Architecture: Fragment entity in Domain layer with no dependencies. Vector configuration in Infrastructure layer using IEntityTypeConfiguration.</constraint>
    <constraint type="architecture">Repository pattern: Extend IRepository&lt;T&gt; with IFragmentRepository interface for vector-specific operations.</constraint>
    <constraint type="database">PostgreSQL 16.0+ required for pgvector extension compatibility.</constraint>
    <constraint type="performance">Target &lt;100ms for top-10 similarity search on 10,000 vectors (supports NFR001 sub-2-second response).</constraint>
    <constraint type="indexing">HNSW indexing for 1536-dimensional vectors (Claude 4.5 embeddings). Parameters: m=16, ef_construction=64.</constraint>
    <constraint type="migration">EF Core migrations must be idempotent and support rollback. Include custom SQL for pgvector extension and HNSW index creation.</constraint>
    <constraint type="testing">Unit tests with mocked DbContext. Integration tests with real PostgreSQL database and sample vector data.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>IFragmentRepository</name>
      <kind>Repository Interface</kind>
      <signature>
public interface IFragmentRepository : IRepository&lt;Fragment&gt;
{
    Task&lt;IEnumerable&lt;Fragment&gt;&gt; FindSimilarAsync(float[] embedding, int limit, double threshold);
    Task&lt;IEnumerable&lt;Fragment&gt;&gt; FindSimilarAsync(float[] embedding, int limit);
}
      </signature>
      <path>src/Medley.Application/Interfaces/IFragmentRepository.cs</path>
      <note>New interface extending IRepository with vector similarity methods</note>
    </interface>
    <interface>
      <name>Fragment Entity</name>
      <kind>Domain Entity</kind>
      <signature>
public class Fragment
{
    public Guid Id { get; set; }
    public string Content { get; set; } = string.Empty;
    public float[]? Embedding { get; set; }  // Vector for pgvector
    public DateTimeOffset CreatedAt { get; set; }
    // Additional properties as per tech spec
}
      </signature>
      <path>src/Medley.Domain/Entities/Fragment.cs</path>
      <note>New entity with vector property for embeddings</note>
    </interface>
    <interface>
      <name>FragmentConfiguration</name>
      <kind>EF Core Configuration</kind>
      <signature>
public class FragmentConfiguration : IEntityTypeConfiguration&lt;Fragment&gt;
{
    public void Configure(EntityTypeBuilder&lt;Fragment&gt; builder)
    {
        builder.HasKey(f =&gt; f.Id);
        builder.Property(f =&gt; f.Embedding)
            .HasColumnType("vector(1536)");
        // HNSW index configuration via raw SQL in migration
    }
}
      </signature>
      <path>src/Medley.Infrastructure/Data/Configurations/FragmentConfiguration.cs</path>
      <note>New configuration class for Fragment entity with vector column mapping</note>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use xUnit for unit and integration tests. Mock ApplicationDbContext for unit tests using Moq or NSubstitute. Integration tests should use real PostgreSQL database with pgvector extension installed. Test vector similarity operations with sample embeddings. Verify migration rollback capability. Follow AAA pattern (Arrange, Act, Assert).
    </standards>
    <locations>
      <location>src/tests/Medley.Tests.Domain/Entities/FragmentTests.cs</location>
      <location>src/tests/Medley.Tests.Infrastructure/Repositories/FragmentRepositoryTests.cs</location>
      <location>src/tests/Medley.Tests.Integration/Data/VectorOperationsTests.cs</location>
    </locations>
    <ideas>
      <idea ac="1">Test pgvector extension installation verification query</idea>
      <idea ac="2">Test Fragment entity with vector property serialization/deserialization</idea>
      <idea ac="2">Test EF Core vector column mapping and database schema generation</idea>
      <idea ac="3">Test HNSW index creation and performance improvement vs sequential scan</idea>
      <idea ac="4">Test migration up and down (rollback) operations</idea>
      <idea ac="5">Test FindSimilarAsync with various embedding vectors and thresholds</idea>
      <idea ac="5">Test cosine distance calculation accuracy</idea>
      <idea ac="5">Performance test: measure query time for top-10 similarity search on 1000+ vectors</idea>
      <idea ac="6">Test connection string configuration and vector operations through EF Core</idea>
      <idea ac="all">Integration test: end-to-end vector storage, indexing, and similarity search</idea>
    </ideas>
  </tests>
</story-context>
